<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NOSTR Chat</title>
  <style>
    body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; }
    #channels { width: 200px; background: #eee; padding: 1rem; overflow-y: auto; }
    #chat { flex: 1; display: flex; flex-direction: column; }
    #header { padding: 1rem; background: #ddd; font-weight: bold; }
    #messages { flex: 1; padding: 1rem; overflow-y: auto; background: #fafafa; }
    #input { display: flex; border-top: 1px solid #ccc; }
    #input input { flex: 1; padding: 1rem; border: none; }
    #input button { padding: 1rem; border: none; background: #333; color: white; }
    .message { margin-bottom: 0.5rem; }
  </style>
</head>
<body>
  <div id="channels"></div>
  <div id="chat">
    <div id="header">#general</div>
    <div id="messages"></div>
    <div id="input">
      <input type="text" id="text" placeholder="Type your message...">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script type="module">
    import { getPublicKey, getEventHash, utils as nostrUtils } from 'https://esm.sh/nostr-tools';
    import { schnorr } from 'https://esm.sh/@noble/curves/secp256k1';

    function getRandomPrivkeyHex() {
      const bytes = crypto.getRandomValues(new Uint8Array(32));
      return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function getRandomAnonName() {
      return "anon" + Math.floor(10000 + Math.random() * 90000);
    }

    async function signEvent(event, privkeyHex) {
      const hash = getEventHash(event);
      const privkeyBytes = nostrUtils.hexToBytes(privkeyHex);
      const sig = await schnorr.sign(hash, privkeyBytes);
      return nostrUtils.bytesToHex(sig);
    }

    window.addEventListener('DOMContentLoaded', () => {
      const relay = new WebSocket("wss://relay.damus.io");

      const channels = [
        { id: "general", label: "General", tag: "chat-general" },
        { id: "random", label: "Random", tag: "chat-random" },
        { id: "tech", label: "Tech", tag: "chat-tech" }
      ];

      let activeChannel = channels[0];
      let messageBuffer = [];

      // Load or generate keypair
      let privkey = localStorage.getItem("nostr_privkey");
      let pubkey = localStorage.getItem("nostr_pubkey");

      if (!privkey || !pubkey) {
        privkey = getRandomPrivkeyHex();
        pubkey = getPublicKey(privkey);
        localStorage.setItem("nostr_privkey", privkey);
        localStorage.setItem("nostr_pubkey", pubkey);
      }

      // Load or prompt for username
      let username = localStorage.getItem("nostr_username");
      if (!username) {
        username = prompt("Enter your name (or leave blank for anonymous):") || getRandomAnonName();
        localStorage.setItem("nostr_username", username);
      }

      const channelsDiv = document.getElementById("channels");
      const messagesDiv = document.getElementById("messages");
      const headerDiv = document.getElementById("header");

      channels.forEach(chan => {
        const btn = document.createElement("button");
        btn.textContent = "#" + chan.label;
        btn.onclick = () => switchChannel(chan);
        btn.style.display = "block";
        btn.style.marginBottom = "0.5rem";
        channelsDiv.appendChild(btn);
      });

      function renderMessages() {
        messagesDiv.innerHTML = "";
        messageBuffer.sort((a, b) => a.created_at - b.created_at);
        messageBuffer.forEach(ev => {
          const msg = document.createElement("div");
          msg.className = "message";
          msg.textContent = ev.content;
          messagesDiv.appendChild(msg);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function switchChannel(channel) {
        activeChannel = channel;
        headerDiv.textContent = "#" + channel.label;
        messagesDiv.innerHTML = "";
        const loadingMsg = document.createElement("em");
        loadingMsg.textContent = "Loading...";
        messagesDiv.appendChild(loadingMsg);
        messageBuffer = [];
        const sub = ["REQ", "sub-" + channel.id, { kinds: [1], "#t": [channel.tag], limit: 50 }];
        relay.send(JSON.stringify(sub));
      }

      window.sendMessage = async function () {
        const input = document.getElementById("text");
        const content = input.value;
        if (!content) return;

        const event = {
          kind: 1,
          created_at: Math.floor(Date.now() / 1000),
          tags: [["t", activeChannel.tag]],
          content: username + ": " + content,
          pubkey: pubkey
        };
        event.id = getEventHash(event);
        event.sig = await signEvent(event, privkey);
        relay.send(JSON.stringify(["EVENT", event]));
        input.value = "";
      }

      relay.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data[0] === "EVENT") {
          const ev = data[2];
          const loading = messagesDiv.querySelector("em");
          if (loading) loading.remove();
          messageBuffer.push(ev);
          renderMessages();
        }
      };

      relay.onopen = () => {
        switchChannel(activeChannel);
      };
    });
  </script>
</body>
</html>

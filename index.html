<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=320,initial-scale=1" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta charset="UTF-8">
  <title>NOSTR Chat</title>
  <style>
    body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; flex-direction: row; }
    #channels { width: 200px; background: #eee; padding: 1rem; overflow-y: auto; }
    #chat { flex: 1; display: flex; flex-direction: column; }
    #header { padding: 1rem; background: #ddd; font-weight: bold; }
    #messages { flex: 1; padding: 1rem; overflow-y: auto; background: #fafafa; }
    #input { display: flex; border-top: 1px solid #ccc; }
    #input input { flex: 1; padding: 1rem; border: none; font-size: 1rem; }
    #input button { padding: 1rem; border: none; background: #333; color: white; font-size: 1rem; }
    .message { margin-bottom: 0.5rem; }
    .channel-button { display: block; border: none; text-align: left; margin-bottom: 1em }
    button { cursor: pointer }

    @media (max-width: 600px) {
      body { flex-direction: column; }
      #channels { display: none; }
      #chat { width: 100vw; height: 100vh; }
    }

    #toggleMenu {
      display: none;
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      z-index: 1000;
      background: #333;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      font-size: 1rem;
    }

    @media (max-width: 600px) {
      #toggleMenu {
        display: block;
      }

      #channels.show {
        display: block !important;
        position: absolute;
        top: 3rem;
        left: 0;
        background: #eee;
        width: 100%;
        height: calc(100vh - 3rem);
        z-index: 999;
      }
    }
  </style>
</head>
<body>
  <button id="toggleMenu" onclick="document.getElementById('channels').classList.toggle('show')">â˜° Menu</button>
  <div id="channels"></div>
  <div id="chat">
    <div id="header">Code for NL <span id="channelName"></span></div>
    <div id="messages"></div>
    <div id="input">
      <input type="text" id="text" placeholder="Schrijf je bericht...">
      <button onclick="sendMessage()">POST</button>
    </div>
  </div>

  <script type="module">
    import { getPublicKey, getEventHash, utils as nostrUtils } from 'https://esm.sh/nostr-tools';
    import { schnorr } from 'https://esm.sh/@noble/curves/secp256k1';

    function getRandomPrivkeyHex() {
      const bytes = crypto.getRandomValues(new Uint8Array(32));
      return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function getRandomAnonName() {
      return "anon" + Math.floor(10000 + Math.random() * 90000);
    }

    async function signEvent(event, privkeyHex) {
      const hash = getEventHash(event);
      const privkeyBytes = nostrUtils.hexToBytes(privkeyHex);
      const sig = await schnorr.sign(hash, privkeyBytes);
      return nostrUtils.bytesToHex(sig);
    }

    window.addEventListener('DOMContentLoaded', () => {
      window.addEventListener('resize', () => {
        const messagesDiv = document.getElementById("messages");
        if (messagesDiv) {
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
      });
      const relay = new WebSocket("wss://relay.damus.io");

      // channels will be loaded from channels.json
      let channels = [];

      let activeChannel = channels[0];
      let messageBuffer = [];

      // Load or generate keypair
      let privkey = localStorage.getItem("nostr_privkey");
      let pubkey = localStorage.getItem("nostr_pubkey");

      if (!privkey || !pubkey) {
        privkey = getRandomPrivkeyHex();
        pubkey = getPublicKey(privkey);
        localStorage.setItem("nostr_privkey", privkey);
        localStorage.setItem("nostr_pubkey", pubkey);
      }

      // Load or prompt for username
      let username = localStorage.getItem("nostr_username");
      if (!username) {
        username = prompt("Enter your name (or leave blank for anonymous):") || getRandomAnonName();
        localStorage.setItem("nostr_username", username);
      }

      const channelsDiv = document.getElementById("channels");
      const messagesDiv = document.getElementById("messages");
      const channelNameDiv = document.getElementById("channelName");
      const inputField = document.getElementById("text");

      inputField.focus();
      inputField.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendMessage();
        }
      });

      function renderChannels() {
        channelsDiv.innerHTML = "";
        channels.forEach(chan => {
          const btn = document.createElement("button");
          btn.textContent = "#" + chan.label;
          btn.className = "channel-button";
          btn.onclick = () => {
            switchChannel(chan);
            document.getElementById('channels').classList.remove('show');
          };
          channelsDiv.appendChild(btn);
        });
      }

      function renderMessages() {
        messagesDiv.innerHTML = "";
        messageBuffer.sort((a, b) => a.created_at - b.created_at);
        messageBuffer.forEach(ev => {
          const msg = document.createElement("div");
          msg.className = "message";
          msg.textContent = ev.content;
          messagesDiv.appendChild(msg);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function switchChannel(channel) {
        activeChannel = channel;
        channelNameDiv.textContent = "#" + channel.label;
        messagesDiv.innerHTML = "";
        const loadingMsg = document.createElement("em");
        loadingMsg.textContent = "Loading...";
        messagesDiv.appendChild(loadingMsg);
        messageBuffer = [];
        const sub = ["REQ", "sub-" + channel.id, { kinds: [1], "#t": [channel.tag], limit: 50 }];
        relay.send(JSON.stringify(sub));
      }

      window.sendMessage = async function () {
        const content = inputField.value;
        if (!content) return;

        const event = {
          kind: 1,
          created_at: Math.floor(Date.now() / 1000),
          tags: [["t", activeChannel.tag]],
          content: username + ": " + content,
          pubkey: pubkey
        };
        event.id = getEventHash(event);
        event.sig = await signEvent(event, privkey);
        relay.send(JSON.stringify(["EVENT", event]));
        inputField.value = "";
      }

      relay.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data[0] === "EVENT") {
          const ev = data[2];
          const loading = messagesDiv.querySelector("em");
          if (loading) loading.remove();
          messageBuffer.push(ev);
          renderMessages();
        }
      };

      relay.onopen = () => {
        fetch('channels.json')
          .then(res => res.json())
          .then(data => {
            channels = data;
            activeChannel = channels[0];
            renderChannels();
            switchChannel(activeChannel);
          })
          .catch(err => {
            console.error("Failed to load channels.json", err);
            messagesDiv.innerHTML = '<p style="color:red">Failed to load channels.json</p>';
          });
      };
    });
  </script>
</body>
</html>
